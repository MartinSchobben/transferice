---
title: "model-types"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{model-types}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(transferice)
```




# Data

For a starters we use again all dinocyst data but exclusively use temperature at a 30 meter water depth as an outcome variable.

```{r data}
library(tidyr)

# unique locations
udinodat <- dplyr::distinct(dinodat, hole_id, .keep_all = TRUE)

# make var acceptable for nlme
nms <- colnames(udinodat)
new_nms <- paste0("taxa", nms[grepl("^[[:digit:]]*$", nms)])
nms[grepl("^[[:digit:]]*$", nms)] <- new_nms
colnames(udinodat) <- nms

```


```{r lme}
fm <- as.formula(
  paste("t_an + p_an + n_an + i_an + o_an + s_an + I_an ~ .")
  )
rand <- as.formula(paste("~", paste0(new_nms, collapse = " + "), "| parameter"))

```


```{r pcs}

# recipe
rcp <- recipes::recipe(fm, data = udinodat) |> 
  recipes::update_role(longitude, latitude, new_role = "spatial variable") |> 
  recipes::step_logit(recipes::all_predictors(), offset = 0.025) |> 
  recipes::step_nzv(recipes::all_outcomes()) |> 
  recipes::step_normalize(recipes::all_outcomes()) |> 
  recipes::step_pca(recipes::all_predictors(), num_comp = 9)
  

cast <- recipes::prep(rcp, training = udinodat) |> 
  # apply to training data
  recipes::bake(new_data = NULL)

cast <- pivot_longer(cast, ends_with("_an"), names_to = "parameter")


cast  <- dplyr::mutate(
  cast, 
  parameter = udinodat$parameter,
  x = udinodat$longitude,
  y = udinodat$latitude
)

md1 <- nlme::lme(value~PC1 + PC2 + PC3 + PC4, data = cast, 
          random = ~PC1 + PC2 + PC3 + PC4|parameter,
          correlation = corSpatial(form = ~x + y|parameter, type = "g" ),
          control = nlme::lmeControl(msMaxIter = 1000, msMaxEval = 1000))

```


```{r plot}

ggplot(cast, aes(value, PC2, color = parameter)) + geom_point()
```

# spatial variance

```{r spat}

library(nlme)

var_md1 <- Variogram(md1, from =  x + y|parameter, robust = TRUE, resType = "pearson")

plot(var_md1, smooth = TRUE)
```